{% extends "base.html" %}

{% block title_content %}Character Creator{% endblock %}

{% block body_content %}
    <div class="main-content">
        <h1>Character Creator</h1>
        <p>Welcome to the character creator! Here you can design your own Dungeons and Dragons character.</p>
        <p>Follow the steps below to build your character:</p>

        <div class="tabs">
            <button class="tab active" onclick="showTab('basicInfo')">Basic Info</button>
            <button class="tab" onclick="showTab('race')">Race</button>
            <button class="tab" onclick="showTab('class')">Class</button>
            <button class="tab" onclick="showTab('attributes')">Attributes</button>
            <button class="tab" onclick="showTab('details')">Character Details</button>
            <button class="tab" onclick="showTab('equipment')">Equipment</button>
            {% if current_user.is_admin %}
                <button class="tab" onclick="showTab('debug')">Admin Tab</button>
            {% else %}
                <p>User is NOT authenticated.</p>
            {% endif %}
        </div>

        <form method="POST" action="{{ url_for('character_bp.create') }}">

            <!-- Basic Info -->
            <div id="basicInfo" class="tab-content active">
                <h2>Basic Info</h2>
                <label for="charname">Enter your character's name:</label>
                <input type="text" id="charname" name="charname" placeholder="Enter character name"><br>

                <label for="ruleset">Choose your ruleset:</label>
                <select id="ruleset" name="ruleset">
                    <option value="2014">2014 (Original)</option>
                    <option value="2024">2024 (Updated)</option>
                </select><br>

                <label for="xp_method">Experience Method:</label>
                <select id="xp_method" name="xp_method">
                    <option value="xp">XP</option>
                    <option value="milestone">Milestone</option>
                </select><br>

                <label for="encumbrance">Encumbrance Rules:</label>
                <select id="encumbrance" name="encumbrance">
                    <option value="yes">Use Encumbrance</option>
                    <option value="no">No Encumbrance</option>
                </select>
            </div>

            <!-- Race -->
            <div id="race" class="tab-content">
                <!-- Make sure to add an option to decide between rulesets somehow (2014 vs 2024) -->
                <h2>Choose Your Race</h2>
                <label for="charrace">Choose your character's race:</label>
                <select id="charrace" name="charrace">
                    {% for dnd_race in all_races %}
                        <option value="{{ dnd_race.race_id }}">
                            {{ dnd_race.name }}
                        </option>
                    {% endfor %}
                </select><br>

                <button type="button" onclick="window.location.href='/homebrew/races'">Browse Homebrew Races</button>
            </div>

            <!-- Class -->
            <div id="class" class="tab-content">
                {% for dnd_class in all_classes %}
                <label for="{{dnd_class.name}}">{{ dnd_class.name }}: </label>
                <button type="button" onclick="adjustStat('{{dnd_class.name}}', -1)">-</button>
                <input type="number" id="{{dnd_class.name}}" name="multiclass_level" value="0" min="0" max="20" readonly>
                <button type="button" onclick="adjustStat('{{dnd_class.name}}', 1)">+</button><br>
                {% endfor %}




                
                
                
                
                <br><button type="button" onclick="window.location.href='/homebrew/classes'">Browse Homebrew Classes</button>
            </div>

            <!-- Attributes -->
            <div id="attributes" class="tab-content">
                <h2>Set Your Attributes</h2>
                <p>Choose a method to determine your stats:</p>
                <label for="stat_method">Stat Allocation Method:</label>
                <select id="stat_method" name="stat_method">
                    <option value="standard_array">Standard Array</option>
                    <option value="point_buy">Point Buy</option>
                    <option value="roll">Roll</option>
                    <option value="manual">Manual</option>
                </select><br>

                <!-- Standard Array -->
                <div id="standard_array" style="display: block;">
                    <p>Assign values from the standard array <span id="attribute_array">[15, 14, 13, 12, 10, 8]</span>:</p>
                </div>

                <!-- Point Buy -->
                <div id="point_buy" style="display: none;">
                    <p>Allocate points (Max 27)<span id="remainingPoints">27</span></p>
                </div>

                <!-- Roll -->
                <div id="roll" style="display: none;">
                    <p>Roll 4d6 and drop the lowest roll for each stat:</p>
                    <button type="button" id="rollStatsButton">Roll Stats</button>
                    <p>Assign values from the standard array <span id="roll_attribute_array">Press the roll button to get your values</span>:</p>
                    <!-- TODO: Make fields to choose the number of, type of, and num of dropped dice" -->
                </div>

                <!-- Manual -->
                <div id="manual" style="display: none;">
                    <p>Manually set stats (1-20):</p>
                </div>

                <!-- Manual or Point Buy (Both should have arrows), Rolling and Array should not -->
                <div id="attribute_fields" style="display: block">
                    <div class="attribute-section">
                        <label for="strength">Strength:</label>
                        <button type="button" onclick="adjustStat('strength', -1)">-</button>
                        <input type="number" id="strength" name="strength" value="8" min="1" max="20" readonly>
                        <button type="button" onclick="adjustStat('strength', 1)">+</button>
                    </div>
                    <div class="attribute-section">
                        <label for="dexterity">Dexterity:</label>
                        <button type="button" onclick="adjustStat('dexterity', -1)">-</button>
                        <input type="number" id="dexterity" name="dexterity" value="8" min="1" max="20" readonly>
                        <button type="button" onclick="adjustStat('dexterity', 1)">+</button>
                    </div>
                    <div class="attribute-section">
                        <label for="constitution">Constitution:</label>
                        <button type="button" onclick="adjustStat('constitution', -1)">-</button>
                        <input type="number" id="constitution" name="constitution" value="8" min="1" max="20" readonly>
                        <button type="button" onclick="adjustStat('constitution', 1)">+</button>
                    </div>
                    <div class="attribute-section">
                        <label for="intelligence">Intelligence:</label>
                        <button type="button" onclick="adjustStat('intelligence', -1)">-</button>
                        <input type="number" id="intelligence" name="intelligence" value="8" min="1" max="20" readonly>
                        <button type="button" onclick="adjustStat('intelligence', 1)">+</button>
                    </div>
                    <div class="attribute-section">
                        <label for="wisdom">Wisdom:</label>
                        <button type="button" onclick="adjustStat('wisdom', -1)">-</button>
                        <input type="number" id="wisdom" name="wisdom" value="8" min="1" max="20" readonly>
                        <button type="button" onclick="adjustStat('wisdom', 1)">+</button>
                    </div>
                    <div class="attribute-section">
                        <label for="charisma">Charisma:</label>
                        <button type="button" onclick="adjustStat('charisma', -1)">-</button>
                        <input type="number" id="charisma" name="charisma" value="8" min="1" max="20" readonly>
                        <button type="button" onclick="adjustStat('charisma', 1)">+</button>
                    </div>
                </div>
                <div id="attribute_fields_dropdown" style="display: block">
                    <div class="attribute-section">
                        <label for="strength">Strength:</label>
                        <select id="strength_dd" name="stat_method" onchange="checkAvailability(this.id, this.value)">
                            <option value="-1">—</option>
                            <option value="0">value 0</option>
                            <option value="1">value 1</option>
                            <option value="2">value 2</option>
                            <option value="3">value 3</option>
                            <option value="4">value 4</option>
                            <option value="5">value 5</option>
                        </select>
                    </div>
                    <div class="attribute-section">
                        <label for="dexterity">Dexterity:</label>
                        <select id="dexterity_dd" name="stat_method" onchange="checkAvailability(this.id, this.value)">
                            <option value="-1">—</option>
                            <option value="0">value 0</option>
                            <option value="1">value 1</option>
                            <option value="2">value 2</option>
                            <option value="3">value 3</option>
                            <option value="4">value 4</option>
                            <option value="5">value 5</option>
                        </select>
                    </div>
                    <div class="attribute-section">
                        <label for="constitution">Constitution:</label>
                        <select id="constitution_dd" name="stat_method" onchange="checkAvailability(this.id, this.value)">
                            <option value="-1">—</option>
                            <option value="0">value 0</option>
                            <option value="1">value 1</option>
                            <option value="2">value 2</option>
                            <option value="3">value 3</option>
                            <option value="4">value 4</option>
                            <option value="5">value 5</option>
                        </select>
                    </div>
                    <div class="attribute-section">
                        <label for="intelligence">Intelligence:</label>
                        <select id="intelligence_dd" name="stat_method" onchange="checkAvailability(this.id, this.value)">
                            <option value="-1">—</option>
                            <option value="0">value 0</option>
                            <option value="1">value 1</option>
                            <option value="2">value 2</option>
                            <option value="3">value 3</option>
                            <option value="4">value 4</option>
                            <option value="5">value 5</option>
                        </select>
                    </div>
                    <div class="attribute-section">
                        <label for="wisdom">Wisdom:</label>
                        <select id="wisdom_dd" name="stat_method" onchange="checkAvailability(this.id, this.value)">
                            <option value="-1">—</option>
                            <option value="0">value 0</option>
                            <option value="1">value 1</option>
                            <option value="2">value 2</option>
                            <option value="3">value 3</option>
                            <option value="4">value 4</option>
                            <option value="5">value 5</option>
                        </select>
                    </div>
                    <div class="attribute-section">
                        <label for="charisma">Charisma:</label>
                        <select id="charisma_dd" name="stat_method" onchange="checkAvailability(this.id, this.value)">
                            <option value="-1">—</option>
                            <option value="0">value 0</option>
                            <option value="1">value 1</option>
                            <option value="2">value 2</option>
                            <option value="3">value 3</option>
                            <option value="4">value 4</option>
                            <option value="5">value 5</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Character Details -->
            <div id="details" class="tab-content">
                <h2>Character Details</h2>
                <label for="background">Choose your character's background:</label>
                <select id="background" name="background">
                    {% for background in all_backgrounds %}
                        <option value="{{ background.id }}">{{ background.name }}</option>
                    {% endfor %}
                </select><br>

                <label for="description">Character Description:</label>
                <textarea id="description" name="description" rows="4"></textarea>
            </div>

            <!-- Equipment -->
            <div id="equipment" class="tab-content">
                <h2>Starting Equipment</h2>
                <p>Select starting equipment based on your background, class, and race:</p>
                <!-- Generate dynamically based on above-mentioned -->
                <div id="equipment-options">
                    {% for item in starting_equipment %}
                        <label>
                            <input type="checkbox" name="equipment" value="{{ item.id }}">
                            {{ item.name }}
                        </label><br>
                    {% endfor %}
                </div>
                <p>Manual fill in for now</p>
                <div class="form-section">
                    <label for="equipmentList">Equipment List</label>
                    <textarea id="equipmentList" rows="4" placeholder="List your character's equipment"></textarea>
                </div>
            </div>
            <div id="debug" class="tab-content">
                <h2>Information from the Database</h2>

                <p>Character Class: {{ current_class if current_class else "None" }}</p>
                <p>Current Level: {{ current_level if current_level else "N/A" }}</p>
                <p>All Classes: {{ all_classes }}</p>
                <p>All Classes: {% for dnd_class in all_classes %}
                    {{ dnd_class.class_id }} <br>
                    {{ dnd_class.name }} <br>
                    {{ dnd_class.description }} <br>
                    {{ dnd_class.hit_die }} <br>
                    {{ dnd_class.is_official }} <br>
                    {% endfor %}
                </p>
            </div>
            <div class="button-group">
                <br><button type="submit">Save Character</button>
            </div>

        </form>

        
    </div>
    <script>
        function generateClassPage(inputClass) {
            parentObject = document.getElementById("class");
            parentObject.innerHTML += `
                <div id="${inputClass}" class="tab-content">
                    <p>This is class ${inputClass}.</p>
                </div>
            `
        }
        
        
        function generateClassTabs(inputClass) {
            
            tabObject = document.getElementById("classtabs");
            tabObject.innerHTML += `<button class="tab" onclick="generateClassPage('${inputClass}'); showTab('${inputClass}')">${inputClass}</button>`
            
        }


        function setCollectiveMax() {
            levels = document.getElementsByClassName("multiclass_level")
            starting_Level = document.getElementById("startlevel");
            
            spare_levels = starting_Level.value;
            for(var levelobj of levels) {
                spare_levels -= levelobj.value
            }

            for(var levelobj of levels) {
                levelobj.setAttribute("max", parseInt(levelobj.value) + spare_levels);
            }
            
        }

        function setMulticlassMax(inputValue) {
                    element = document.getElementById("multiclass");
                    
                    element.setAttribute("max", inputValue);
                    
                    if(parseInt(element.value) > inputValue) {
                        element.value = inputValue;
                        updateClasses(inputValue);
                    }
                }


        function updateClasses(value) {
            document.getElementById("classdisplay").innerHTML = "";
            if(value==1) {
                document.getElementById("classdisplay").innerHTML += `
                    <div id="classdisplay">
                        <label for="multiclass_id">Class: </label>
                        <select id="multiclass_id" name="multiclass_id">
                            {% for dnd_class in all_classes %}
                                <option value="{{ dnd_class.class_id }}">
                                    {{ dnd_class.name }}
                                </option>
                            {% endfor %}
                        </select><input type="number" id="multiclass_level" name="multiclass_level" class="multiclass_level" min="1" max="20" value="1" onchange="setCollectiveMax()">
                    </div>
                `
            }
            else {
                for(var i = 0; i < value; i++) {
                document.getElementById("classdisplay").innerHTML += `
                        <div id="classdisplay">
                            <label for="multiclass_id">Class ${i + 1}: </label>
                            <select id="multiclass_id" name="multiclass_id">
                                {% for dnd_class in all_classes %}
                                    <option value="{{ dnd_class.class_id }}">
                                        {{ dnd_class.name }}
                                    </option>
                                {% endfor %}
                            </select><input type="number" id="multiclass_level" name="multiclass_level" class="multiclass_level" min="1" max="20" value="1" onchange="setCollectiveMax()">
                        </div>
                    `;
                }
            }

        }

        // Show and hide attribute sections based on selected method
        document.getElementById('stat_method').addEventListener('change', function () {
            const method = this.value;
            // Hide all sections
            document.getElementById('standard_array').style.display = 'none';
            document.getElementById('point_buy').style.display = 'none';
            document.getElementById('roll').style.display = 'none';
            document.getElementById('manual').style.display = 'none';

            // Show the selected section
            document.getElementById(method).style.display = 'block';

            // Reset remaining points if switching to Point Buy
            if (method === 'point_buy') {
                remainingPoints = maxPoints;
                document.getElementById('remainingPoints').innerText = `Points left: ${remainingPoints}`;
                document.getElementById('remainingPoints').style.display = 'block';
            } else {
                document.getElementById('remainingPoints').style.display = 'none';
            }

            // Reset all attribute stats to default value
            if (method === 'point_buy' || method === 'manual') {
                document.querySelectorAll('#attribute_fields input[type="number"]').forEach(input => {
                    input.value = method === 'point_buy' ? 8 : 10; // Reset to Point Buy or Manual defaults
                });
            } else {
                // Hide initial values
                const dropdowns = document.querySelectorAll('#attribute_fields_dropdown select');
                dropdowns.forEach(dropdown => {
                    const options = dropdown.querySelectorAll('option');

                    options.forEach(option => {
                        const value = parseInt(option.getAttribute('value'), 10); // Check the value attribute
                        option.text = "—";
                        if (method === 'standard_array') {
                            option.style.display = '';
                            option.text = (() => {
                                switch (value) {
                                    case 0: return 15;
                                    case 1: return 14;
                                    case 2: return 13;
                                    case 3: return 12;
                                    case 4: return 10;
                                    case 5: return 8;
                                    default: return "—";
                                }
                            })();
                        } else if (value >= 0) {
                            option.style.display = 'none'; // Hide the option
                        }
                    });
                    dropdown.value = -1;
                });
            }
            updateAllButtonsVisibility();
        });

        // This is unfortunately necessary because loading the page will otherwise not be considered a "change" (dumb)
        // Effectively calls the above on load
        document.getElementById('stat_method').dispatchEvent(new Event('change'));

        function checkAvailability(statId, optionValue) {
            if (optionValue == -1) {
                return;
            }
            const isStandardArray = document.getElementById('stat_method').value === 'standard_array';
            // We want to check that the optionValue being chosen either does not match the optionValue for any other stat (dropdown) or there are enough of that value to go around
            const currentDropdown = document.getElementById(statId);
            // Get all dropdowns in the attribute fields container
            const dropdowns = document.querySelectorAll('#attribute_fields_dropdown select');

            if (isStandardArray) {
                dropdowns.forEach(dropdown => {
                    if (dropdown.value == optionValue && currentDropdown != dropdown) {
                        dropdown.value = -1;
                        const event = new Event('change');
                        dropdown.dispatchEvent(event);
                    }
                });
            } else { // Is Rolls
                const spanText = document.getElementById('roll_attribute_array').textContent;
                // Split text into array
                const valuesArray = spanText.split(', ').map(value => value.trim());

                // Create a dictionary from the array of values
                let valueDict = {};
                valuesArray.forEach(value => {
                    if (!isNaN(value)) { // Check if the value is a valid number. Keep this
                        if (valueDict[value] === undefined) {
                            valueDict[value] = 1; // Initialize count as 1 if it is the first occurrence
                        } else {
                            valueDict[value]++; // Increment the count if the value already exists
                        }
                    }
                });
                console.log(valueDict);

                let occurrences = 0;
                dropdowns.forEach(dropdown => {
                    const selectedOption = dropdown.querySelector(`option[value="${dropdown.value}"]`);
                    console.log("selected option: " + selectedOption);
                    // Check for the actual text value of our option (is a number. DON'T PARSEINT. didn't work when I did)
                    const optionText = selectedOption.textContent;
                    if (dropdown.value == optionValue && currentDropdown != dropdown) {
                        occurrences++;
                        console.log("occurrences: " + occurrences);
                        if (occurrences >= (valueDict[optionText])) {
                            // admittedly, this feels like it removes at random so
                            //it's a tiny bit janky but it isn't random. Don't know
                            //what alternative there'd be with this implementation
                            dropdown.value = -1;
                            console.log("success???")
                        }
                    }
                });
            }
        }

        // Point Buy implementation
        const maxPoints = 27;
        let remainingPoints = maxPoints;

        function adjustStat(statId, change) {
            const statInput = document.getElementById(statId);
            let currentValue = parseInt(statInput.value);
            // Assuming buttons being available to be pressed logic works, this is always true, but safeguard
            if (currentValue + change >= statInput.min && currentValue + change <= statInput.max) {

                // Handle Point Buy logic if applicable
                if (document.getElementById('point_buy').style.display !== 'none') {
                    if (change == 1) {
                        // + button hit going to 14 or 15
                        if (currentValue + change >= 14) {
                            remainingPoints -= 2;
                        } else {
                            remainingPoints -= 1;
                        }
                    } else {
                        // - button hit going to 14 or 13
                        if (currentValue + change >= 13) {
                            remainingPoints += 2;
                        } else {
                            remainingPoints += 1;
                        }
                    }
                    // Actually update the value
                    statInput.value = currentValue + change;
                } else {
                    // Manual Adjustment
                    statInput.value = currentValue + change;
                }

                // Update remaining points display if using Point Buy
                const remainingPointsDisplay = document.getElementById('remainingPoints');
                if (remainingPointsDisplay.style.display !== 'none') {
                    remainingPointsDisplay.innerText = `Points left: ${remainingPoints}`;
                }
                updateAllButtonsVisibility();
            }
        }

        // Handles + and - button visibility. TODO: Change this to control disabled vs enabled rather than visibility. How?
        function updateAllButtonsVisibility() {
            const isPointBuy = document.getElementById('stat_method').value === 'point_buy';
            const isManual = document.getElementById('stat_method').value === 'manual';

            document.querySelectorAll('#attribute_fields input[type="number"]').forEach(statInput => {
                const statId = statInput.id;
                const increaseButton = statInput.nextElementSibling;
                const decreaseButton = statInput.previousElementSibling;
                if (isPointBuy || isManual) {
                    const currentValue = parseInt(statInput.value);

                    // Maximum and minimum limits for Point Buy and Manual modes
                    const maxLimit = isPointBuy ? 15 : 20;
                    const minLimit = isPointBuy ? 8 : 1;

                    // Determine if there are sufficient points for Point Buy
                    const canIncrease = isPointBuy
                    ? remainingPoints >= 2 || (remainingPoints >= 1 && currentValue <= 12)
                    : true;

                    // Show/hide buttons based on conditions
                    increaseButton.style.visibility = (currentValue < maxLimit && canIncrease) ? 'visible' : 'hidden';
                    decreaseButton.style.visibility = (currentValue > minLimit) ? 'visible' : 'hidden'; // No need to check remaining points on decrease
                } else {
                    increaseButton.style.visibility = 'hidden';
                    decreaseButton.style.visibility = 'hidden';
                }
            });
        }


        // Roll stats with 3 inputs. Not configurable yet by user
        function rollStats(numDice = 4, diceType = 6, dropLowest = 1) {
            const attributes = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
            let results = [];
            attributes.forEach(attribute => { // Now that self assign, technically no point in this but still iterates correct number of times
                let rolls = [];

                // Roll the dice
                for (let i = 0; i < numDice; i++) {
                    rolls.push(Math.floor(Math.random() * diceType) + 1);
                }

                // Sort rolls and drop the lowest Z
                rolls.sort((a, b) => a - b);
                const keptRolls = rolls.slice(dropLowest);

                // Calculate the total and update the field
                const total = keptRolls.reduce((sum, roll) => sum + roll, 0);
                results.push(total);
            });
            results.sort((a, b) => b - a);
            // Hide initial values
            const dropdowns = document.querySelectorAll('#attribute_fields_dropdown select');
            dropdowns.forEach(dropdown => {
                let seenValues = []
                const options = dropdown.querySelectorAll('option');

                options.forEach(option => {
                    const value = parseInt(option.getAttribute('value'), 10); // Check the value attribute
                    option.text = "—";
                    option.style.display = '';
                    prospectiveText = (() => {
                        switch (value) {
                            case 0: return results[0];
                            case 1: return results[1];
                            case 2: return results[2];
                            case 3: return results[3];
                            case 4: return results[4];
                            case 5: return results[5];
                            default: return "—";
                        }
                    })();
                    option.text = prospectiveText;
                    if (seenValues.includes(prospectiveText)) {
                        option.style.display = 'none'; // Hide the option if there's a duplicate
                    }
                    seenValues.push(prospectiveText);
                });
                // Remove "—" from seenValues and sort
                seenValues = seenValues.filter(value => value !== "—").sort((a, b) => b - a);
                // Display seenValues in the roll_attribute_array span
                const seenValuesSpan = document.getElementById('roll_attribute_array');
                if (seenValuesSpan) {
                    seenValuesSpan.textContent = seenValues.join(', '); // Update span with comma-separated list of seenValues
                }
                dropdown.value = -1;
            });
        }

        // Example usage: roll 4d6 and drop the lowest 1 TODO: Make it versatile to user definition
        document.getElementById('rollStatsButton').addEventListener('click', function() {
            rollStats(4, 6, 1);
        });

        // Are we still using this?
        function showLevel() {
            document.getElementById("test").innerHTML = document.getElementById('charname').value;
        }

        // For the big tabs at top but can reuse for my class implementation idea
        function showTab(tabId) {
            // Remove 'active' class from all tabs and tab contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add 'active' class to selected tab and corresponding content
            document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

    </script>

{% endblock %}