{% extends "base.html" %}

{% block title_content %}{{ character_id }}'s Profile{% endblock %}

{% block body_content %}
    <div class="main-content">
        <h1>Character Creator</h1>
        <p>Welcome to the character creator! Here you can design your own Dungeons and Dragons character.</p>
        <p>Follow the steps below to build your character:</p>

        <div class="tabs">
            <button class="tab active" onclick="showTab('basicInfo')">Basic Info</button>
            <button class="tab" onclick="showTab('race')">Race</button>
            <button class="tab" onclick="showTab('class')">Class</button>
            <button class="tab" onclick="showTab('attributes')">Attributes</button>
            <button class="tab" onclick="showTab('details')">Character Details</button>
            <button class="tab" onclick="showTab('equipment')">Equipment</button>
        </div>

        <form method="POST" action="{{ url_for('character_bp.create') }}">

            <!-- Basic Info -->
            <div id="basicInfo" class="tab-content active">
                <h2>Basic Info</h2>
                <label for="charname">Enter your character's name:</label>
                <input type="text" id="charname" name="charname" placeholder="Enter character name"><br>

                <label for="ruleset">Choose your ruleset:</label>
                <select id="ruleset" name="ruleset">
                    <option value="2014">2014 (Original)</option>
                    <option value="2024">2024 (Updated)</option>
                </select><br>

                <label for="xp_method">Experience Method:</label>
                <select id="xp_method" name="xp_method">
                    <option value="xp">XP</option>
                    <option value="milestone">Milestone</option>
                </select><br>

                <label for="encumbrance">Encumbrance Rules:</label>
                <select id="encumbrance" name="encumbrance">
                    <option value="yes">Use Encumbrance</option>
                    <option value="no">No Encumbrance</option>
                </select>
            </div>

            <!-- Race -->
            <div id="race" class="tab-content">
                <!-- Make sure to add an option to decide between rulesets somehow (2014 vs 2024) -->
                <h2>Choose Your Race</h2>
                <label for="charrace">Choose your character's race:</label>
                <select id="charrace" name="charrace">
                    {% for dnd_race in all_races %}
                        <option value="{{ dnd_race.race_id }}">
                            {{ dnd_race.name }}
                        </option>
                    {% endfor %}
                </select><br>

                <button type="button" onclick="window.location.href='/homebrew/races'">Browse Homebrew Races</button>
            </div>

            <!-- Class -->
            <div id="class" class="tab-content">
                <h2>Choose Your Class</h2>
                <label for="startlevel">Enter your character's starting level:</label>
                <input type="number" id="startlevel" name="startlevel" min="1" max="20" value="1" onchange="setMulticlassMax(startlevel.value)"><br>

                <label for="multiclass">Enter how many classes you would like to use (Cannot exceed starting level):</label><br>
                <input type="number" id="multiclass" name="multiclass" min="1" max="1" value="1" onchange="updateClasses(multiclass.value)"><br>

                <label for="classdisplay">Choose your class or classes:</label>
                <div id="classdisplay">
                    <label for="class_1">Class: </label>
                    <select id="class_id" name="class_id">
                        {% for dnd_class in all_classes %}
                            <option value="{{ dnd_class.class_id }}">
                                {{ dnd_class.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <button type="button" onclick="window.location.href='/homebrew/classes'">Browse Homebrew Classes</button>
            </div>

            <!-- Attributes -->
            <div id="attributes" class="tab-content">
                <h2>Set Your Attributes</h2>
                <p>Choose a method to determine your stats:</p>
                <label for="stat_method">Stat Allocation Method:</label>
                <select id="stat_method" name="stat_method">
                    <option value="array">Standard Array</option>
                    <option value="point_buy">Point Buy</option>
                    <option value="roll">Roll</option>
                    <option value="manual">Manual</option>
                </select><br>

                <div id="manualRollPast" style="display: none;">
                    <label>Roll for stats:</label>
                    <button type="button" onclick="rollStats()">Roll 4 Dice</button><br>
                    <textarea id="rollResults" readonly rows="4" placeholder="Your rolls will appear here"></textarea>
                </div>

                <div id="standard_array" style="display: block;"> <!-- Default view -->
                    <p>Click the value you want for strength:</p>
                    <button type="button" id="assignAttribute">Assign strength</button>
                    <!-- More of them. Don't know how we will make this look good but eh -->
                </div>

                <div id="point_buy" style="display: none;">
                    <p>Increase or decrease attributes until you have used all 27 points.</p>
                </div>

                <div id="roll" style="display: none;">
                    <p>Roll 4d6 and drop the lowest roll for each stat:</p>
                    <button type="button" id="rollStatsButton">Roll Stats</button>
                    <!-- TODO: Make fields to choose the number of, type of, and num of dropped dice" -->
                </div>

                <div id="manual" style="display: none;">
                    <p>Insert the values of stats that you want.</p>
                </div>

                <div class="attribute-section">
                    <label for="strength">Strength:</label>
                    <input type="number" id="strength" name="strength" value="10" min="1" max="20">
                </div>
                <div class="attribute-section">
                    <label for="dexterity">Dexterity:</label>
                    <input type="number" id="dexterity" name="dexterity" value="10" min="1" max="20">
                </div>
                <div class="attribute-section">
                    <label for="constitution">Constitution:</label>
                    <input type="number" id="constitution" name="constitution" value="10" min="1" max="20">
                </div>
                <div class="attribute-section">
                    <label for="intelligence">Intelligence:</label>
                    <input type="number" id="intelligence" name="intelligence" value="10" min="1" max="20">
                </div>
                <div class="attribute-section">
                    <label for="wisdom">Wisdom:</label>
                    <input type="number" id="wisdom" name="wisdom" value="10" min="1" max="20">
                </div>
                <div class="attribute-section">
                    <label for="charisma">Charisma:</label>
                    <input type="number" id="charisma" name="charisma" value="10" min="1" max="20">
                </div>
            </div>

            <!-- Character Details -->
            <div id="details" class="tab-content">
                <h2>Character Details</h2>
                <label for="background">Choose your character's background:</label>
                <select id="background" name="background">
                    {% for background in all_backgrounds %}
                        <option value="{{ background.id }}">{{ background.name }}</option>
                    {% endfor %}
                </select><br>

                <label for="description">Character Description:</label>
                <textarea id="description" name="description" rows="4"></textarea>
            </div>

            <!-- Equipment -->
            <div id="equipment" class="tab-content">
                <h2>Starting Equipment</h2>
                <p>Select starting equipment based on your background, class, and race:</p>
                <!-- Generate dynamically based on above-mentioned -->
                <div id="equipment-options">
                    {% for item in starting_equipment %}
                        <label>
                            <input type="checkbox" name="equipment" value="{{ item.id }}">
                            {{ item.name }}
                        </label><br>
                    {% endfor %}
                </div>
                <p>Manual fill in for now</p>
                <div class="form-section">
                    <label for="equipmentList">Equipment List</label>
                    <textarea id="equipmentList" rows="4" placeholder="List your character's equipment"></textarea>
                </div>
            </div>

            <div class="button-group">
                <button type="submit">Save Character</button>
            </div>

        </form>
    </div>
    <script>
        function setMulticlassMax(inputValue) {
                    element = document.getElementById("multiclass");
                    element.setAttribute("max", inputValue);
                    if(parseInt(element.value) > inputValue) {
                        element.value = inputValue;
                        updateClasses(inputValue);
                    }
                }


        function updateClasses(value) {
            document.getElementById("classdisplay").innerHTML = "";
            if(value==1) {
                document.getElementById("classdisplay").innerHTML += `
                    <div id="classdisplay">
                        <label for="class1">Class: </label>
                        <select id="class_id" name="class_id">
                            {% for dnd_class in all_classes %}
                                <option value="{{ dnd_class.class_id }}">
                                    {{ dnd_class.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                `
            }
            else {
                for(var i = 0; i < value; i++) {
                document.getElementById("classdisplay").innerHTML += `
                        <div id="classdisplay">
                            <label for="class${i + 1}">Class ${i + 1}: </label>
                            <select id="class_id" name="class_id">
                                {% for dnd_class in all_classes %}
                                    <option value="{{ dnd_class.class_id }}">
                                        {{ dnd_class.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    `;
                }
            }

        }
      
      
      
      
        // Function to ensure multiclass value doesn't exceed starting level
        function validateMulticlass() {
            const startLevel = parseInt(document.getElementById('startlevel').value) || 1;
            const multiclass = document.getElementById('multiclass');

            // If multiclass exceeds starting level, adjust it
            if (parseInt(multiclass.value) > startLevel) {
                multiclass.value = startLevel;
            }
        }

        // Toggle rolling section visibility
        document.getElementById('stat_method').addEventListener('change', function() {
            document.getElementById('standard_array').style.display = this.value === 'array' ? 'block' : 'none';
            document.getElementById('point_buy').style.display = this.value === 'point_buy' ? 'block' : 'none';
            document.getElementById('roll').style.display = this.value === 'roll' ? 'block' : 'none';
            document.getElementById('manual').style.display = this.value === 'manual' ? 'block' : 'none';
        });

        function rollStats(numDice = 4, diceType = 6, dropLowest = 1) {
            const attributes = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
            attributes.forEach(attribute => {
                let rolls = [];

                // Roll the dice
                for (let i = 0; i < numDice; i++) {
                    rolls.push(Math.floor(Math.random() * diceType) + 1);
                }

                // Sort rolls and drop the lowest Z
                rolls.sort((a, b) => a - b);
                const keptRolls = rolls.slice(dropLowest);

                // Calculate the total and update the field
                const total = keptRolls.reduce((sum, roll) => sum + roll, 0);
                document.getElementById(attribute).value = total;
            });
        }

        // Example usage: roll 4d6 and drop the lowest 1 TODO: Make it versatile to user definition
        document.getElementById('rollStatsButton').addEventListener('click', function() {
            rollStats(4, 6, 1);
        });

        function showLevel() {
            document.getElementById("test").innerHTML = document.getElementById('charname').value;
        }

        function showTab(tabId) {
            // Remove 'active' class from all tabs and tab contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add 'active' class to selected tab and corresponding content
            document.querySelector(`button[onclick="showTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        function incrementValue(id) {
            const input = document.getElementById(id);
            const max = parseInt(input.max);
            const value = parseInt(input.value);
            if (value < max) {
                input.value = value + 1;
            }
        }

        function decrementValue(id) {
            const input = document.getElementById(id);
            const min = parseInt(input.min);
            const value = parseInt(input.value);
            if (value > min) {
                input.value = value - 1;
            }
        }
    </script>

{% endblock %}